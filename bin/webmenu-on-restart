#!/usr/bin/ruby1.9.1

require "json"
require "net/http"
require "uri"


if ENV["CRASH_TYPE"] == "restart"
  `notify-send --urgency=critical "Webmenu crashed" "restarting..."`
end

record = {
  :uuid => (0...25).map{ ('a'..'z').to_a[rand(26)] }.join,
  :msg => "webmenu crash",
  :type => ENV["CRASH_TYPE"]
}

record["log"] = `tail --lines=100 #{ ENV["WM_LOG_FILE"] }`.split("\n")

res = Net::HTTP.post_form(
  URI("http://127.0.0.1:8888/webmenu"),
  :json => record.to_json
)

if res.code != "200"
  puts "Bad HTTP Response #{ res.code.inspect }: #{ res.body }"
end

if ENV["CRASH_TYPE"] == "error"
`zenity --title Menu --error --text 'Sorry but the Menu has crashed :(

Please contact support with the error id below and we will fix it! :)

Error id: #{ record[:uuid] }' &`
else
  puts "Sleeping for 5s"
  sleep 5
end


