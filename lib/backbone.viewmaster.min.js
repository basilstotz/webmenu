(function(){function t(e){return _.isArray(e)?e:[e]}var e="1.1.0pre";Backbone.ViewMaster=Backbone.View.extend({constructor:function(e){Backbone.View.prototype.constructor.apply(this,arguments),this.rendered=!1,this.parent=null,this._views={},this._eventBindings=[],this._remove=[],this._bubble=null,this._dirty={}},bindTo:function(e,t,n,r){var i;return r=r||this,typeof n=="string"&&(n=this[n]),i={emitter:e,context:r,callback:n,event:t},e.on(t,n,r),this._eventBindings.push(i),i},unbindAll:function(){var e;while(e=this._eventBindings.shift())this.unbindFrom(e);return this},unbindFrom:function(e){return e.emitter.off(e.event,e.callback,e.context||this),this},elements:{},template:function(){throw new Error("Template function not defined!")},context:function(){return this.model?this.model.toJSON():{}},render:function(e){e=e||{},this.eachView(function(e,t){t.$el.detach()}),e.detached=!0,this.$el.html(this.template(this.context()));var t,n;for(t in this.elements)n=this.elements[t],this[t]=this.$(n);return this.rendered=!0,this.refreshViews(e),this},refreshViews:function(e){e=e||{};var t=this,n=this._dirty,r;while(r=this._remove.shift())r.remove();return this.eachView(function(r,i){var s=n[r]||e.force,o=!i.rendered||e.force;s&&i.$el.detach(),o&&i.render(e),(s||e.detached)&&t.$(r).append(i.el)}),this._dirty={},this},_removeParent:function(){if(!this.parent)return;var e;for(e in this.parent._views)this.parent._views[e]=_.without(this.parent._views[e],this);return this.unbindFrom(this._bubble),this._bubble=null,this.parent=null,this},_prepareViews:function(e){var n=this;_.each(t(e),function(e){e.parent&&e.parent!==n&&e._removeParent(),e._bubble||(e._bubble=e.bindTo(e,"all",function(){var e=arguments[1];(!e||typeof e.parent=="undefined"||e.parent)&&n.trigger.apply(n,arguments)},e)),e.parent=n})},eachView:function(e){var t,n,r,i=this._views;for(t in i)for(r=0;r<i[t].length;r++)n=i[t][r],e(t,n)},setView:function(e,n){var r;n=t(n);if(r=this._views[e])this._remove=this._remove.concat(_.difference(r,n));return this._prepareViews(n),this._views[e]=n,this._dirty[e]=!0,this},insertView:function(e,n,r){var i;return(i=this._views[e])?i.splice.apply(i,[n,0].concat(t(r))):this._views[e]=t(r),this._dirty[e]=!0,this},appendView:function(e,n){return this._prepareViews(n),this._views[e]=(this._views[e]||[]).concat(t(n)),this._dirty[e]=!0,this},prependView:function(e,n){return this._prepareViews(n),this._views[e]=t(n).concat(this._views[e]||[]),this._dirty[e]=!0,this},getViews:function(e){var t;if(t=this._views[e])return t.slice()},detach:function(){return this._removeParent(),this.$el.detach(),this},remove:function(){return Backbone.View.prototype.remove.apply(this,arguments),this.unbindAll(),this._removeParent(),this.eachView(function(e,t){t.remove()}),this}}),Backbone.ViewMaster.VERSION=e})();